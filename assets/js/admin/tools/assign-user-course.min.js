import TomSelect from"tom-select";import{lpFetchAPI}from"../../utils.js";import Api from"../../api.js";export default function assignUserCourse(){let e,t;const s=(e,t,s)=>{if(!e)return;t={...{maxItems:5,options:[],plugins:{remove_button:{title:"Remove this item"}},load(e,t){s(e,t)}},...t};const o=new TomSelect(e,t);s("",o.setupOptions,o)},o=(e,t,s)=>{const o=Api.admin.apiSearchCourses,n={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({c_search:e})};lpFetchAPI(o,n,{success:e=>{const o=e.data.map((e=>({value:e.ID,text:e.post_title+`(#${e.ID})`})));"function"==typeof t&&("setupOptions"===t.name?s.setupOptions(o):t(o))}})},n=(e,t,s)=>{const o=Api.admin.apiSearchUsers,n={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({search:e})};lpFetchAPI(o,n,{success:e=>{const o=e.data.map((e=>({value:e.ID,text:`${e.display_name} (#${e.ID}) - ${e.user_email}`})));"function"==typeof t&&("setupOptions"===t.name?s.setupOptions(o):t(o))}})},r=(t,s,o,n)=>{const i=Api.admin.apiAssignUserCourse,c={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({data:s,page:o,totalPage:n})},a=e.querySelector(".percent"),p=e.querySelector(".lp-button-assign-course"),u=e.querySelector(".message");p.disabled=!0,lpFetchAPI(i,c,{success:e=>{const{status:o,message:i}=e;if("success"===o){let o=parseInt(e.data.page);const i=5*o,c=i+5;s=t.slice(i,c),a.innerHTML=e.data.percent,r(t,s,++o,n)}else"finished"===o?(a.innerHTML="",u.style.color="green",u.innerHTML=i,setTimeout((()=>{u.innerHTML=""}),2e3),p.disabled=!1):"error"===o&&(p.disabled=!1,u.style.color="red",u.innerHTML=i,setTimeout((()=>{u.innerHTML=""}),2e3))},error:e=>{p.disabled=!1,u.innerHTML=e.message},completed:()=>{}})};document.addEventListener("DOMContentLoaded",(()=>{e=document.querySelector("#lp-assign-user-course-form"),t=document.querySelector("#lp-unassign-user-course-form"),e&&(e.addEventListener("submit",(e=>{console.log("submit"),e.preventDefault();const t=new FormData(e.target),s=Object.fromEntries(Array.from(t.keys(),(e=>{const s=t.getAll(e);return[e,s.length>1?s:s.pop()]})));let o=[],n=[];"string"==typeof s.course_ids?o.push(s.course_ids):"object"==typeof s.course_ids&&(o=s.course_ids),"string"==typeof s.user_ids?n.push(s.user_ids):"object"==typeof s.user_ids&&(n=s.user_ids);const i=[];o.map(((e,t)=>{const s={};s.course_id=e,n.map(((e,t)=>{const o={...s,user_id:e};i.push(o)}))}));const c=i.slice(0,5),a=Math.ceil(i.length/5);r(i,c,1,a)})),(()=>{const t=e.querySelector("[name=course_ids]");t&&s(t,{},o)})(),(()=>{const t=e.querySelector("[name=user_ids]");t&&s(t,{},n)})(),(()=>{const e=t.querySelector("[name=course_ids]");e&&s(e,{},o)})(),(()=>{const e=t.querySelector("[name=user_ids]");e&&s(e,{},n)})())}))}