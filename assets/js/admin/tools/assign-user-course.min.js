import TomSelect from"tom-select";import{lpFetchAPI}from"../../utils.js";import Api from"../../api.js";export default function assignUserCourse(){let e,t;const s=(e,t,s)=>{if(!e)return;t={...{maxItems:5,options:[],plugins:{remove_button:{title:"Remove this item"}},load(e,t){s(e,t)}},...t};new TomSelect(e,t)},n=e=>{let t=[],s=[];"string"==typeof e.course_ids?t.push(e.course_ids):"object"==typeof e.course_ids&&(t=e.course_ids),"string"==typeof e.user_ids?s.push(e.user_ids):"object"==typeof e.user_ids&&(s=e.user_ids);const n=[];t.map(((e,t)=>{const o={};o.course_id=e,s.map(((e,t)=>{const s={...o,user_id:e};n.push(s)}))}));const o=n.slice(0,5),r=Math.ceil(n.length/5);return{packages:n,data:o,totalPage:r}},o=(n="",r,i)=>{const a=Api.admin.apiSearchCourses,c={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({c_search:n})};lpFetchAPI(a,c,{success:a=>{const c=a.data.map((e=>({value:e.ID,text:e.post_title+`(#${e.ID})`})));if(""===n){const n=e.querySelector("[name=course_ids]");n&&s(n,{options:c},o);const r=t.querySelector("[name=course_ids]");r&&s(r,{options:c},o)}"function"==typeof r&&("setupOptions"===r.name?i.setupOptions(c):r(c))}})},r=(n="",o,i)=>{const a=Api.admin.apiSearchUsers,c={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({search:n})};lpFetchAPI(a,c,{success:a=>{const c=a.data.map((e=>({value:e.ID,text:`${e.display_name} (#${e.ID}) - ${e.user_email}`})));if(""===n){const n=e.querySelector("[name=user_ids]");n&&s(n,{options:c},r);const o=t.querySelector("[name=user_ids]");o&&s(o,{options:c},r)}"function"==typeof o&&("setupOptions"===o.name?i.setupOptions(c):o(c))}})},i=(t,s,n,o)=>{const r=Api.admin.apiAssignUserCourse,a={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({data:s,page:n,totalPage:o})},c=e.querySelector(".percent"),u=e.querySelector(".lp-button-assign-course"),p=e.querySelector(".message");u.disabled=!0,lpFetchAPI(r,a,{success:e=>{const{status:n,message:r}=e;if("success"===n){let n=parseInt(e.data.page);const r=5*n,a=r+5;s=t.slice(r,a),c.innerHTML=e.data.percent,i(t,s,++n,o)}else"finished"===n?(c.innerHTML="",p.style.color="green",p.innerHTML=r,setTimeout((()=>{p.innerHTML=""}),2e3),u.disabled=!1):"error"===n&&(u.disabled=!1,p.style.color="red",p.innerHTML=r,setTimeout((()=>{p.innerHTML=""}),2e3))},error:e=>{u.disabled=!1,p.innerHTML=e.message},completed:()=>{}})},a=(e,s,n,o)=>{const r=Api.admin.apiUnAssignUserCourse,i={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({data:s,page:n,totalPage:o})},c=t.querySelector(".percent"),u=t.querySelector(".lp-button-unassign-course"),p=t.querySelector(".message");u.disabled=!0,lpFetchAPI(r,i,{success:t=>{const{status:n,message:r}=t;if("success"===n){let n=parseInt(t.data.page);const r=5*n,i=r+5;s=e.slice(r,i),c.innerHTML=t.data.percent,a(e,s,++n,o)}else"finished"===n?(c.innerHTML="",p.style.color="green",p.innerHTML=r,setTimeout((()=>{p.innerHTML=""}),2e3),u.disabled=!1):"error"===n&&(u.disabled=!1,p.style.color="red",p.innerHTML=r,setTimeout((()=>{p.innerHTML=""}),2e3))},error:e=>{u.disabled=!1,p.innerHTML=e.message},completed:()=>{}})};document.addEventListener("DOMContentLoaded",(()=>{e=document.querySelector("#lp-assign-user-course-form"),t=document.querySelector("#lp-unassign-user-course-form"),e&&(o(),r(),document.querySelector("form")&&document.addEventListener("submit",(e=>{const t=e.target,s=new FormData(e.target),o=Object.fromEntries(Array.from(s.keys(),(e=>{const t=s.getAll(e);return[e,t.length>1?t:t.pop()]})));if("lp-assign-user-course-form"===t.id){if(e.preventDefault(),!confirm("Are you sure you want to Assign?"))return;const{packages:t,data:s,totalPage:r}=n(o);i(t,s,1,r)}else if("lp-unassign-user-course-form"===t.id){if(e.preventDefault(),!confirm("Are you sure you want to Unassign?"))return;const{packages:t,data:s,totalPage:r}=n(o);a(t,s,1,r)}})))}))}