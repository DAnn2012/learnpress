const $=jQuery,$doc=$(document),$win=$(window),makePaymentsSortable=function t(){$(".learn-press-payments.sortable tbody").sortable({handle:".dashicons-menu",helper:(t,a)=>(a.children().each(function(){$(this).width($(this).width())}),a),axis:"y",start(t,a){},stop(t,a){},update(t,a){let l=$(this).children().map(function(){return $(this).find('input[name="payment-order"]').val()}).get();$.post({url:"",data:{"lp-ajax":"update-payment-order",order:l,nonce:$("input[name=lp-settings-nonce]").val()},success(t){}})}})},lpMetaboxCustomFields=()=>{$(".lp-metabox__custom-fields").on("click",".lp-metabox-custom-field-button",function(){let a=$(this).data("row").replace(/lp_metabox_custom_fields_key/gi,Math.floor(1e3*Math.random())+1);return $(this).closest("table").find("tbody").append(a),t($(this).closest(".lp-metabox__custom-fields")),!1}),$(".lp-metabox__custom-fields").on("click","a.delete",function(){return $(this).closest("tr").remove(),t($(this).closest(".lp-metabox__custom-fields")),!1}),$(".lp-metabox__custom-fields tbody").sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65,update(a,l){t($(this).closest(".lp-metabox__custom-fields"))}});let t=t=>{let a=t.find("tbody tr");a.each(function(t,a){$(this).find(".sort .count").val(t)})}},lpMetaboxRepeaterField=()=>{let t=t=>{let a=t.find(".lp_repeater_meta_box__field");a.each(function(t,a){$(this).find(".lp_repeater_meta_box__field__count").val(t),$(this).find(".lp_repeater_meta_box__title__title > span").text(t+1)})};$(".lp_repeater_meta_box__add").on("click",function(){let a=$(this).data("add").replace(/lp_metabox_repeater_key/gi,Math.floor(1e3*Math.random())+1);return $(this).closest(".lp_repeater_meta_box__wrapper").find(".lp_repeater_meta_box__fields").append(a),t($(this).closest(".lp_repeater_meta_box__wrapper")),$(this).closest(".lp_repeater_meta_box__wrapper").find(".lp_repeater_meta_box__fields").last().find("input").trigger("focus"),!1}),$(".lp_repeater_meta_box__wrapper").on("click","a.lp_repeater_meta_box__title__delete",function(){return $(this).closest(".lp_repeater_meta_box__field").remove(),t($(this).closest(".lp_repeater_meta_box__wrapper")),!1}),$(".lp_repeater_meta_box__fields").on("click",".lp_repeater_meta_box__title__toggle, .lp_repeater_meta_box__title__title",function(){let t=$(this).closest(".lp_repeater_meta_box__field");return t.hasClass("lp_repeater_meta_box__field_active")?t.removeClass("lp_repeater_meta_box__field_active"):t.addClass("lp_repeater_meta_box__field_active"),!1}),$(".lp_repeater_meta_box__fields").sortable({items:".lp_repeater_meta_box__field",cursor:"grab",axis:"y",handle:".lp_repeater_meta_box__title__sort",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65,update(a,l){t($(this).closest(".lp_repeater_meta_box__wrapper"))}})},lpMetaboxExtraInfo=()=>{$(".lp_course_extra_meta_box__add").on("click",function(){return $(this).closest(".lp_course_extra_meta_box__content").find(".lp_course_extra_meta_box__fields").append($(this).data("add")),$(this).closest(".lp_course_extra_meta_box__content").find(".lp_course_extra_meta_box__field").last().find("input").trigger("focus"),!1}),document.querySelectorAll(".lp_course_extra_meta_box__fields").forEach(t=>{t.addEventListener("keydown",a=>{let l=t.querySelectorAll(".lp_course_extra_meta_box__input");if(13===a.keyCode)return a.preventDefault(),l.forEach(t=>{t.blur()}),!1})}),$(".lp_course_extra_meta_box__fields").on("click","a.delete",function(){return $(this).closest(".lp_course_extra_meta_box__field").remove(),!1}),$(".lp_course_extra_meta_box__fields").sortable({items:".lp_course_extra_meta_box__field",cursor:"grab",axis:"y",handle:".sort",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65}),$(".lp_course_faq_meta_box__add").on("click",function(){return $(this).closest(".lp_course_faq_meta_box__content").find(".lp_course_faq_meta_box__fields").append($(this).data("add")),!1}),document.querySelectorAll(".lp_course_faq_meta_box__fields").forEach(t=>{t.addEventListener("keydown",a=>{let l=t.querySelectorAll(".lp_course_faq_meta_box__field input"),i=t.querySelectorAll(".lp_course_faq_meta_box__field textarea");if(13===a.keyCode)return a.preventDefault(),[...l,...i].forEach(t=>{t.blur()}),!1})}),$(".lp_course_faq_meta_box__fields").on("click","a.delete",function(){return $(this).closest(".lp_course_faq_meta_box__field").remove(),!1}),$(".lp_course_faq_meta_box__fields").sortable({items:".lp_course_faq_meta_box__field",cursor:"grab",axis:"y",handle:".sort",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65})},lpGetFinalQuiz=()=>{let t=document.querySelectorAll(".lp-metabox-get-final-quiz");[...t].map(t=>{t.addEventListener("click",l=>{l.preventDefault();let i=t.textContent,s=t.dataset.loading,o=document.querySelector(".lp-metabox-evaluate-final_quiz");o&&o.remove(),t.textContent=s,a(t).then(a=>{let{message:l,data:s}=a;t.textContent=i;let o=document.createElement("div");o.className="lp-metabox-evaluate-final_quiz",o.innerHTML=s||l,t.parentNode.insertBefore(o,t.nextSibling)})})});let a=async t=>{let a=await wp.apiFetch({path:"lp/v1/admin/course/get_final_quiz",method:"POST",data:{courseId:t.dataset.postid||""}});return a}},lpMetaboxColorPicker=()=>{$(".lp-metabox__colorpick").iris({change(t,a){$(this).parent().find(".colorpickpreview").css({backgroundColor:a.color.toString()})},hide:!0,border:!0}).on("click focus",function(t){t.stopPropagation(),$(".iris-picker").hide(),$(this).closest("td").find(".iris-picker").show(),$(this).data("original-value",$(this).val())}).on("change",function(){if($(this).is(".iris-error")){let t=$(this).data("original-value");t.match(/^\#([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/)?$(this).val($(this).data("original-value")).trigger("change"):$(this).val("").trigger("change")}}),$("body").on("click",function(){$(".iris-picker").hide()})},lpMetaboxImage=()=>{$(".lp-metabox-field__image").each((t,a)=>{let l,i=$(a).find(".lp-metabox-field__image--add"),s=$(a).find(".lp-metabox-field__image--delete"),o=$(a).find(".lp-metabox-field__image--image"),n=$(a).find(".lp-metabox-field__image--id");n.val()?(i.hide(),s.show()):(i.show(),s.hide()),i.on("click",t=>{if(t.preventDefault(),l){l.open();return}(l=wp.media({title:i.data("choose"),button:{text:i.data("update")},multiple:!1})).on("select",function(){let t=l.state().get("selection").first().toJSON(),a=t.sizes&&t.sizes.thumbnail?t.sizes.thumbnail.url:t.url;o.append('<div class="lp-metabox-field__image--inner"><img src="'+a+'" alt="" style="max-width:100%;"/></div>'),n.val(t.id),i.hide(),s.show()}),l.open()}),s.on("click",t=>{t.preventDefault(),o.html(""),i.show(),s.hide(),n.val("")})})},lpMetaboxImageAdvanced=()=>{$(".lp-metabox-field__image-advanced").each((t,a)=>{let l,i=$(a).find("#lp-gallery-images-ids"),s=$(a).find(".lp-metabox-field__image-advanced-images"),o=$(a).find(".lp-metabox-field__image-advanced-upload > a");$(o).on("click",t=>{if(t.preventDefault(),l){l.open();return}(l=wp.media({title:o.data("choose"),button:{text:o.data("update")},states:[new wp.media.controller.Library({title:o.data("choose"),filterable:"all",multiple:!0}),]})).on("select",function(){let t=l.state().get("selection"),a=i.val();t.forEach(function(t){if((t=t.toJSON()).id){a=a?a+","+t.id:t.id;let l=t.sizes&&t.sizes.thumbnail?t.sizes.thumbnail.url:t.url;s.append('<li class="image" data-attachment_id="'+t.id+'"><img src="'+l+'" /><ul class="actions"><li><a href="#" class="delete" title="'+o.data("delete")+'">'+o.data("text")+"</a></li></ul></li>")}}),i.val(a)}),l.open()}),s.sortable({items:"li.image",cursor:"move",scrollSensitivity:40,forcePlaceholderSize:!0,forceHelperSize:!1,helper:"clone",opacity:.65,placeholder:"lp-metabox-sortable-placeholder",start(t,a){a.item.css("background-color","#f6f6f6")},stop(t,a){a.item.removeAttr("style")},update(){let t="";s.find("li.image").css("cursor","default").each(function(){let a=$(this).attr("data-attachment_id");t=t+a+","}),i.val(t)}}),$(s).find("li.image").each((t,a)=>{let l=$(a).find("a.delete");l.on("click",()=>{$(a).remove();let t="";return $(s).find("li.image").css("cursor","default").each(function(){let a=$(this).attr("data-attachment_id");t=t+a+","}),i.val(t),!1})})})},lpMetaboxCourseTabs=()=>{$(document.body).on("lp-metabox-course-tab-panels",function(){$("ul.lp-meta-box__course-tab__tabs").show(),$("ul.lp-meta-box__course-tab__tabs a").on("click",function(t){t.preventDefault();let a=$(this).closest("div.lp-meta-box__course-tab");$("ul.lp-meta-box__course-tab__tabs li",a).removeClass("active"),$(this).parent().addClass("active"),$("div.lp-meta-box-course-panels",a).hide(),$($(this).attr("href")).show()}),$("div.lp-meta-box__course-tab").each(function(){$(this).find("ul.lp-meta-box__course-tab__tabs li").eq(0).find("a").trigger("click")})}).trigger("lp-metabox-course-tab-panels")},lpMetaboxCondition=()=>{let t=document.querySelectorAll(".lp-meta-box .form-field");t.forEach(t=>{t.hasAttribute("data-show")&&t.dataset.show?lpMetaboxConditionType(t,t.dataset.show,"show"):t.hasAttribute("data-hide")&&t.dataset.hide&&lpMetaboxConditionType(t,t.dataset.hide,"hide")})},lpMetaboxConditionType=(t,a,l="show")=>{let i=JSON.parse(a),s=document.querySelectorAll(`input[id^="${i[0]}"]`),o="="===i[1]?"=":"!=",n=i[2],r=(a,i,s)=>{if("checkbox"===a){let r=n;"yes"===n||"1"===n||1===n||"true"===n?r=!0:("no"===n||"0"===n||0===n||"false"===n)&&(r=!1),"!="==o&&r!==Boolean(s?s.checked:i.checked)?t.style.display="show"===l?"":"none":"="==o&&r==Boolean(s?s.checked:i.checked)?t.style.display="show"===l?"":"none":t.style.display="show"===l?"none":""}};s.forEach(t=>{let a=t.getAttribute("type");r(a,t),t.addEventListener("change",l=>{let i=l.target;r(a,t,i)})})},initTooltips=function t(){$(".learn-press-tooltip").each(function(){let t=$(this),a=$.extend({title:"data-tooltip",offset:10,gravity:"s"},t.data());t.tipsy(a)})},initSelect2=function t(){if($.fn.select2){let a=$(".lp-select-2 select");a.select2({placeholder:"Select a value"}),a.on("change.select2",function(t){let a=$(t.target),l=a.val();l.length||a.val(null)}),$(".lp_autocomplete_metabox_field").each(function(){let t=$(this).data("atts"),a=t.action;a||(a="users"===t.data?t.rest_url+"wp/v2/users":t.rest_url+"wp/v2/"+t.data),$(this).find("select").select2({placeholder:t.placeholder?t.placeholder:"Select",ajax:{url:a,dataType:"json",delay:250,beforeSend(a){a.setRequestHeader("X-WP-Nonce",t.nonce)},data:t=>({search:t.term}),processResults:t=>({results:t.map(t=>({id:t.id,text:t.title&&t.title.rendered?t.title.rendered:t.name}))}),cache:!0},minimumInputLength:2})})}},initSingleCoursePermalink=function t(){$doc.on("change",'.learn-press-single-course-permalink input[type="radio"]',function(){let t=$(this),a=t.closest(".learn-press-single-course-permalink");a.hasClass("custom-base")?a.find('input[type="text"]').prop("readonly",!1):a.siblings(".custom-base").find('input[type="text"]').prop("readonly",!0)}).on("change","input.learn-press-course-base",function(){$("#course_permalink_structure").val($(this).val())}).on("focus","#course_permalink_structure",function(){$("#learn_press_custom_permalink").click()}).on("change","#learn_press_courses_page_id",function(){$("tr.learn-press-courses-page-id").toggleClass("hide-if-js",!parseInt(this.value))})},togglePaymentStatus=function t(a){a.preventDefault();let l=$(this).closest("tr"),i=($(this),l.find(".status").hasClass("enabled")?"no":"yes");$.ajax({url:"",data:{"lp-ajax":"update-payment-status",status:i,id:l.data("payment"),nonce:$("input[name=lp-settings-nonce]").val()},success(t){for(let a in t=LP.parseJSON(t))$("#payment-"+a+" .status").toggleClass("enabled",t[a])}})},updateEmailStatus=function t(){(function(){$.post({url:window.location.href,data:{"lp-ajax":"update_email_status",status:$(this).parent().hasClass("enabled")?"no":"yes",id:$(this).data("id"),nonce:$("input[name=lp-settings-nonce]").val()},dataType:"text",success:$.proxy(function(t){for(let a in t=LP.parseJSON(t))$("#email-"+a+" .status").toggleClass("enabled",t[a])},this)})}).apply(this)},lpMetaboxsalePriceDate=()=>{if(!$("#course-settings").length)return;$(".lp_sale_dates_fields").each(function(){let t=$(this).closest("#price_course_data"),a=!1;$(this).find("input").each(function(){""!==$(this).val()&&(a=!0)}),a?(t.find(".lp_sale_price_schedule").hide(),t.find(".lp_sale_dates_fields").show()):(t.find(".lp_sale_price_schedule").show(),t.find(".lp_sale_dates_fields").hide())}),$(".lp-meta-box-course-panels").on("click",".lp_sale_price_schedule",function(){let t=$(this).closest("#price_course_data");return $(this).hide(),t.find(".lp_cancel_sale_schedule").show(),t.find(".lp_sale_dates_fields").show(),!1}),$(".lp-meta-box-course-panels").on("click",".lp_cancel_sale_schedule",function(){let t=$(this).closest("div.lp-meta-box-course-panels");return $(this).hide(),t.find(".lp_sale_price_schedule").show(),t.find(".lp_sale_dates_fields").hide(),t.find(".lp_sale_dates_fields").find("input").val(""),!1}),$(document).on("input","#price_course_data",function(t){let a=$(this),l=$(".lp_meta_box_regular_price"),i=$(".lp_meta_box_sale_price"),s=$(t.target).attr("id");a.find(".learn-press-tip-floating").remove(),parseInt(i.val())>parseInt(l.val())&&("_lp_price"===s?l.parent(".form-field").append('<div class="learn-press-tip-floating">'+lpAdminCourseEditorSettings.i18n.notice_price+"</div>"):"_lp_sale_price"===s&&i.parent(".form-field").append('<div class="learn-press-tip-floating">'+lpAdminCourseEditorSettings.i18n.notice_sale_price+"</div>"))});let t=function(t){let a=$(t).is("#_lp_sale_start")?"minDate":"maxDate",l="minDate"===a?$("#_lp_sale_end"):$("#_lp_sale_start"),i=$(t).datetimepicker("getDate");$(l).datetimepicker("option",a,i),$(t).trigger("change")};$(".lp_sale_dates_fields").each(function(){$(this).find("input").datetimepicker({timeFormat:"HH:mm",separator:" ",dateFormat:"yy-mm-dd",showButtonPanel:!0,onSelect(){t($(this))}}),$(this).find("input").each(function(){t($(this))})})},lpHidePassingGrade=()=>{let t=["evaluate_final_quiz","evaluate_final_assignment"],a=document.querySelectorAll("input[type=radio][name=_lp_course_result]");[...a].map((a,l)=>(a.checked&&t.includes(a.value)&&$("._lp_passing_condition_field").hide(),null)),$("input[type=radio][name=_lp_course_result]").on("change",function(a){t.includes(a.target.value)?$("._lp_passing_condition_field").hide():$("._lp_passing_condition_field").show()})},callbackFilterTemplates=function t(){let a=$(this);if(a.hasClass("current"))return!1;let l=$("#learn-press-template-files"),i=l.find("tr[data-template]"),s=a.data("template"),o=a.data("filter");return a.addClass("current").siblings("a").removeClass("current"),s?i.map(function(){$(this).toggleClass("hide-if-js",$(this).data("template")!==s)}):o?i.map(function(){$(this).toggleClass("hide-if-js","yes"!==$(this).data("filter-"+o))}):i.removeClass("hide-if-js"),$("#learn-press-no-templates").toggleClass("hide-if-js",!!l.find("tr.template-row:not(.hide-if-js):first").length),!1},toggleEmails=function t(a){a.preventDefault();let l=$(this),i=l.data("status");$.ajax({url:"",data:{"lp-ajax":"update_email_status",status:i},success(t){for(let a in t=LP.parseJSON(t))$("#email-"+a+" .status").toggleClass("enabled",t[a])}})},importCourses=function t(){let a=$("#learn-press-install-sample-data-notice"),l=$(this).attr("data-action");l&&(e.preventDefault(),"yes"===l?a.find(".install-sample-data-notice").slideUp().siblings(".install-sample-data-loading").slideDown():a.fadeOut(),$.ajax({url:ajaxurl,dataType:"html",type:"post",data:{action:"learnpress_install_sample_data",yes:l},success(t){(t=LP.parseJSON(t)).url?$.ajax({url:t.url,success(){a.find(".install-sample-data-notice").html(t.message).slideDown().siblings(".install-sample-data-loading").slideUp()}}):a.find(".install-sample-data-notice").html(t.message).slideDown().siblings(".install-sample-data-loading").slideUp()}}))},onReady=function t(){makePaymentsSortable(),initSelect2(),initTooltips(),initSingleCoursePermalink(),lpMetaboxCourseTabs(),lpMetaboxCustomFields(),lpMetaboxColorPicker(),lpMetaboxImageAdvanced(),lpMetaboxImage(),lpMetaboxsalePriceDate(),lpMetaboxExtraInfo(),lpHidePassingGrade(),lpGetFinalQuiz(),lpMetaboxCondition(),lpMetaboxRepeaterField(),$(document).on("click",".learn-press-payments .status .dashicons",togglePaymentStatus).on("click",".change-email-status",updateEmailStatus).on("click",".learn-press-filter-template",callbackFilterTemplates).on("click","#learn-press-enable-emails, #learn-press-disable-emails",toggleEmails).on("click","#learn-press-install-sample-data-notice a",importCourses)};$(document).ready(onReady);